<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTU - Dashboard</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Abhaya+Libre:wght@400;600;800&family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        kanit: ['Kanit', 'sans-serif'],
                        abhaya: ['"Abhaya Libre"', 'serif'],
                    },
                    colors: {
                        neonPurple: '#b026ff',
                        neonBlue: '#26c6ff',
                        neonGreen: '#39ff14',
                        deepBg: '#0f0c29',
                        lightBg: '#f0f4f8',
                        navDark: '#1f2024',
                        navLight: '#ffffff',
                    },
                    animation: {
                        'spin-disk': 'spin 4s linear infinite',
                        'bounce-slight': 'bounceSlight 2s infinite',
                    },
                    keyframes: {
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(-2%)' },
                            '50%': { transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles */
        body {
            font-family: 'Kanit', sans-serif;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Backgrounds */
        .dark .bg-animated {
            background: linear-gradient(-45deg, #301046, #090979, #2b0336, #00d4ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        .bg-animated { background: #f0f4f8; }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glass Panels */
        .glass-panel {
            background: rgba(15, 12, 41, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(139, 92, 246, 0.4);
        }
        html:not(.dark) .glass-panel {
             background: rgba(255, 255, 255, 0.95);
             border: 1px solid rgba(0, 0, 0, 0.1);
             color: #000;
        }

        /* Navbar */
        .nav-custom { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        html:not(.dark) .nav-custom { border-bottom: 1px solid rgba(0, 0, 0, 0.1); }

        /* Subject Card Hover */
        .subject-card {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
        }
        .subject-card:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 0 25px rgba(176, 38, 255, 0.5);
            z-index: 10;
        }

        /* Scrollbar for Modal List */
        .chapter-list::-webkit-scrollbar { width: 6px; }
        .chapter-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .chapter-list::-webkit-scrollbar-thumb { background: #b026ff; border-radius: 10px; }

        /* Disc Animation */
        .disc-wrapper { transition: transform 0.3s ease; }
        .disc-img { animation: spin-disk 4s linear infinite; animation-play-state: paused; transition: filter 0.3s ease; }
        .disc-wrapper:hover { transform: scale(1.1); }
        .disc-wrapper:hover .disc-img { filter: grayscale(100%); animation-play-state: paused !important; }

        /* Loader */
        #preloader { transition: opacity 0.8s ease-out, visibility 0.8s; }
        #main-content { filter: blur(10px); transition: filter 1s ease-out; }
        .loader-ring {
            width: 80px; height: 80px; border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #b026ff; border-right-color: #26c6ff; border-bottom-color: #ff265c;
            animation: spin-linear 1s linear infinite; 
        }
        @keyframes spin-linear { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-spacer { height: 140px; }
    </style>
</head>
<body class="text-gray-900 dark:text-white min-h-screen relative overflow-x-hidden bg-animated">

    <!-- Preloader -->
    <div id="preloader" class="fixed inset-0 z-[100] bg-deepBg flex items-center justify-center backdrop-blur-xl">
        <div class="loader-ring"></div>
    </div>

    <!-- Particle Background -->
    <div id="particles" class="fixed inset-0 pointer-events-none z-0"></div>

    <!-- Main Content -->
    <div id="main-content" class="relative z-10 w-full min-h-screen flex flex-col justify-between">

        <!-- Header (Nav + Marquee) -->
        <header class="fixed top-0 left-0 w-full z-50 flex flex-col shadow-2xl">
            <!-- Navbar -->
            <nav class="w-full bg-navLight dark:bg-navDark nav-custom px-6 py-2 flex justify-between items-center transition-colors duration-300 z-50 h-20">
                <!-- Left: Logo -->
                <div class="flex items-center">
                    <a href="index.html">
                        <img src="web_icon.png" alt="Logo" class="h-24 md:h-32 w-auto object-contain hover:scale-105 transition duration-300 drop-shadow-[0_0_8px_rgba(255,255,255,0.4)] mt-2">
                    </a>
                </div>

                <!-- Right: Profile & Settings -->
                <div class="flex items-center space-x-6">
                    <!-- User Profile Display -->
                    <div id="user-profile" class="flex items-center gap-4 glass-panel pl-8 pr-4 py-1.5 rounded-full border border-purple-500/50 min-w-[200px] justify-between cursor-default">
                        <div class="flex items-center gap-3">
                            <img id="user-school-logo" src="" class="w-10 h-10 rounded-full border-2 border-white/50 bg-white object-contain">
                            <div class="flex flex-col">
                                <span id="user-name-display" class="font-kanit text-base font-bold dark:text-white text-black">User</span>
                                <span class="text-[10px] text-green-500 font-bold uppercase tracking-wider">Online</span>
                            </div>
                        </div>
                        <div class="h-6 w-px bg-gray-500/50 mx-2"></div>
                        <button onclick="openLogoutModal()" class="group flex items-center gap-2 text-red-500 hover:text-red-600 transition-all">
                            <i class="fas fa-power-off text-lg"></i>
                        </button>
                    </div>

                    <!-- Settings Menu -->
                    <div class="relative">
                        <button onclick="toggleMenu()" class="w-10 h-10 rounded-full border border-gray-400/30 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-white/10 transition text-current">
                            <i class="fas fa-ellipsis-v text-lg"></i>
                        </button>
                        <div id="settings-menu" class="absolute right-0 top-14 w-52 glass-panel rounded-xl p-2 hidden transform origin-top-right transition-all duration-200 scale-95 opacity-0 text-white shadow-2xl">
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between items-center p-3 rounded-lg hover:bg-white/10 cursor-pointer text-gray-800 dark:text-white" onclick="toggleTheme()">
                                    <span class="text-base font-kanit"><i class="fas fa-adjust mr-2"></i>Theme</span>
                                    <i id="theme-icon" class="fas fa-moon text-yellow-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Marquee -->
            <div class="w-full bg-gradient-to-r from-blue-800 to-blue-600 h-8 flex items-center border-b border-white/20 shadow-lg overflow-hidden">
                <marquee scrollamount="10" class="text-base font-bold text-white font-abhaya tracking-widest leading-none mt-1">
                    ONLINE TESTING UNIVERSITY &nbsp;&nbsp;&nbsp; • &nbsp;&nbsp;&nbsp; SELECT YOUR SUBJECT &nbsp;&nbsp;&nbsp; • &nbsp;&nbsp;&nbsp; PREPARE FOR SUCCESS
                </marquee>
            </div>
        </header>

        <div class="header-spacer"></div>

        <!-- Main Content Grid -->
        <main class="flex-grow flex flex-col md:flex-row items-center justify-center relative w-full max-w-[1920px] mx-auto mt-6 px-6">
            
            <!-- Left: Subject Selection (Grid) -->
            <div class="w-full md:w-1/2 z-20 flex flex-col items-center md:items-start pl-4 md:pl-28 pr-6 space-y-8">
                
                <h1 class="text-3xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 mb-4 self-center md:self-start">
                    เลือกรายวิชา (Select Subject)
                </h1>

                <!-- Subject Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
                    
                    <!-- Math Card -->
                    <div onclick="openSubjectModal('math')" class="subject-card cursor-pointer group relative h-64 rounded-2xl overflow-hidden border border-white/10 glass-panel shadow-lg">
                        <img src="Math_ico.jpg" class="absolute inset-0 w-full h-full object-cover transition duration-500 group-hover:scale-110 opacity-60 group-hover:opacity-40">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <h2 class="text-2xl md:text-3xl font-bold text-white drop-shadow-[0_0_10px_rgba(0,0,0,0.8)] tracking-wide group-hover:text-neonBlue transition">
                                คณิตศาสตร์
                            </h2>
                        </div>
                    </div>

                    <!-- Science Card -->
                    <div onclick="openSubjectModal('sci')" class="subject-card cursor-pointer group relative h-64 rounded-2xl overflow-hidden border border-white/10 glass-panel shadow-lg">
                        <img src="sci.webp" class="absolute inset-0 w-full h-full object-cover transition duration-500 group-hover:scale-110 opacity-60 group-hover:opacity-40">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <h2 class="text-2xl md:text-3xl font-bold text-white drop-shadow-[0_0_10px_rgba(0,0,0,0.8)] tracking-wide group-hover:text-neonGreen transition">
                                วิทยาศาสตร์
                            </h2>
                        </div>
                    </div>

                    <!-- English Card -->
                    <div onclick="openSubjectModal('eng')" class="subject-card cursor-pointer group relative h-64 rounded-2xl overflow-hidden border border-white/10 glass-panel shadow-lg">
                        <img src="eng.jpeg" class="absolute inset-0 w-full h-full object-cover transition duration-500 group-hover:scale-110 opacity-60 group-hover:opacity-40">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <h2 class="text-2xl md:text-3xl font-bold text-white drop-shadow-[0_0_10px_rgba(0,0,0,0.8)] tracking-wide group-hover:text-neonPurple transition">
                                ภาษาอังกฤษ
                            </h2>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Right: Image (Consistent with Index) -->
            <div class="w-full md:w-1/2 h-[50vh] md:h-[80vh] relative flex justify-end items-end mt-10 md:mt-0 pointer-events-none">
                <div class="absolute bottom-0 right-0 w-[40vw] h-[40vw] max-w-[600px] max-h-[600px] bg-purple-600 rounded-full filter blur-[100px] opacity-30 animate-pulse"></div>
                <img id="ayanokoji-img" 
                     src="anime.jpg" 
                     alt="Character" 
                     class="relative h-full w-auto object-contain object-right-bottom z-10 drop-shadow-[0_0_10px_rgba(255,255,255,0.2)]">
            </div>

        </main>
    </div>

    <!-- Music Player -->
    <div class="fixed bottom-8 right-8 z-40 flex flex-col items-center group">
        <div id="music-info" class="mb-3 text-right opacity-0 transition-opacity duration-500 bg-black/70 p-3 rounded-xl backdrop-blur-md border border-white/10">
            <p id="song-title" class="text-sm font-bold text-neonBlue whitespace-nowrap">Classroom of the Elite OST</p>
            <p id="song-artist" class="text-xs text-gray-300 whitespace-nowrap">Now Playing</p>
        </div>
        <div class="disc-wrapper cursor-pointer w-28 h-28 relative" onclick="togglePlay()">
             <div class="absolute top-1/2 left-1/2 w-4 h-4 bg-black rounded-full transform -translate-x-1/2 -translate-y-1/2 z-20 border border-gray-700"></div>
             <img src="disc.png" alt="Music Disc" class="disc-img w-full h-full object-cover rounded-full shadow-[0_0_20px_rgba(0,0,0,0.6)] border-4 border-gray-800">
             <div id="play-status" class="absolute inset-0 flex items-center justify-center z-30 opacity-0 group-hover:opacity-100 transition-opacity bg-black/30 rounded-full">
                 <i id="play-icon" class="fas fa-play text-white text-3xl drop-shadow-md"></i>
             </div>
        </div>
    </div>
    
    <!-- Hidden YT Player -->
    <div id="youtube-player" class="hidden"></div>

    <!-- Subject Detail Modal (The "UI Box") -->
    <div id="subject-modal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md" onclick="closeSubjectModal()"></div>
        <div class="relative w-full h-full flex items-center justify-center p-4">
            <!-- Modal Container (Split View) -->
            <div class="w-full max-w-5xl h-[80vh] glass-panel rounded-3xl shadow-[0_0_60px_rgba(38,198,255,0.4)] border border-blue-500/30 overflow-hidden flex flex-col md:flex-row transform scale-95 opacity-0 transition-all duration-300" id="subject-modal-box">
                
                <!-- Close Button -->
                <button onclick="closeSubjectModal()" class="absolute top-4 right-4 z-50 text-gray-400 hover:text-red-500 transition hover:rotate-90">
                    <i class="fas fa-times text-2xl"></i>
                </button>

                <!-- Left Side: Chapter List -->
                <div class="w-full md:w-1/3 bg-black/40 border-r border-white/10 flex flex-col h-full">
                    <div class="p-6 border-b border-white/10 bg-white/5">
                        <h2 id="modal-subject-title" class="text-2xl font-bold text-white">รายวิชา</h2>
                        <p class="text-xs text-gray-400 mt-1">ระดับชั้นมัธยมศึกษาปีที่ 3</p>
                    </div>
                    <div id="chapter-list-container" class="chapter-list flex-1 overflow-y-auto p-4 space-y-3">
                        <!-- Chapters injected by JS -->
                    </div>
                </div>

                <!-- Right Side: Details -->
                <div class="w-full md:w-2/3 p-8 md:p-12 flex flex-col justify-center items-center text-center relative">
                    <div id="chapter-detail-content" class="w-full max-w-lg space-y-6">
                        <div class="inline-block px-4 py-1 rounded-full bg-blue-500/20 text-neonBlue text-sm font-bold tracking-wider mb-2 border border-blue-500/30">
                            <span id="detail-chapter-num">เลือกบทเรียน</span>
                        </div>
                        <h3 id="detail-chapter-title" class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400">
                            ยินดีต้อนรับ
                        </h3>
                        <p id="detail-chapter-desc" class="text-lg text-gray-400 font-light leading-relaxed">
                            กรุณาเลือกบทเรียนจากเมนูทางด้านซ้ายเพื่อดูรายละเอียดและเริ่มทำแบบทดสอบ
                        </p>
                        
                        <button onclick="startTest()" id="start-test-btn" class="hidden mt-8 px-10 py-4 rounded-full bg-gradient-to-r from-neonBlue to-purple-600 hover:from-purple-600 hover:to-neonBlue text-white font-bold text-xl shadow-[0_0_20px_rgba(38,198,255,0.4)] transition-all hover:scale-105">
                            <i class="fas fa-play mr-2"></i> เริ่มทำแบบทดสอบ
                        </button>
                    </div>
                    
                    <!-- Background Decoration -->
                    <div class="absolute inset-0 pointer-events-none opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logout-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeLogoutModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel p-8 rounded-2xl shadow-2xl text-center border border-purple-500/30 w-[90%] max-w-sm">
            <h3 class="text-2xl font-bold mb-6 text-white">ยืนยันการออกจากระบบ?</h3>
            <div class="flex gap-4 justify-center">
                <button onclick="confirmLogout()" class="px-6 py-2 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 rounded-xl text-white font-bold transition shadow-lg">ใช่, ออกจากระบบ</button>
                <button onclick="closeLogoutModal()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-xl text-white font-bold transition border border-white/10">ยกเลิก</button>
            </div>
        </div>
    </div>

    <script>
        // --- Data: M.3 Curriculum ---
        const subjectsData = {
            math: {
                title: "คณิตศาสตร์ (Mathematics)",
                chapters: [
                    { id: 1, title: "อสมการเชิงเส้นตัวแปรเดียว", desc: "การแก้อสมการเชิงเส้นตัวแปรเดียว และการเขียนกราฟแสดงคำตอบ" },
                    { id: 2, title: "การแยกตัวประกอบพหุนาม", desc: "การแยกตัวประกอบของพหุนามดีกรีสูงกว่าสอง" },
                    { id: 3, title: "สมการกำลังสองตัวแปรเดียว", desc: "การแก้สมการกำลังสองตัวแปรเดียว โดยวิธีแยกตัวประกอบและสูตร" },
                    { id: 4, title: "ความคล้าย", desc: "สมบัติของรูปสามเหลี่ยมที่คล้ายกันและการนำไปใช้" },
                    { id: 5, title: "กราฟของฟังก์ชันกำลังสอง", desc: "ลักษณะของกราฟพาราโบลา จุดยอด แกนสมมาตร" },
                    { id: 6, title: "สถิติ (3)", desc: "แผนภาพกล่องและการแปลความหมายผลลัพธ์" },
                    { id: 7, title: "ระบบสมการเชิงเส้นสองตัวแปร", desc: "การแก้ระบบสมการเชิงเส้นสองตัวแปรและโจทย์ปัญหา" },
                    { id: 8, title: "วงกลม", desc: "ส่วนต่างๆ ของวงกลม มุมที่จุดศูนย์กลางและมุมในส่วนโค้ง" },
                    { id: 9, title: "พีระมิด กรวย และทรงกลม", desc: "การหาพื้นที่ผิวและปริมาตรของรูปเรขาคณิตสามมิติ" },
                    { id: 10, title: "ความน่าจะเป็น", desc: "การทดลองสุ่ม เหตุการณ์ และการหาความน่าจะเป็น" },
                    { id: 11, title: "อัตราส่วนตรีโกณมิติ", desc: "ไซน์ โคไซน์ แทนเจนต์ และการนำไปใช้หาระยะทาง" }
                ]
            },
            sci: {
                title: "วิทยาศาสตร์ (Science)",
                chapters: [
                    { id: 1, title: "คลื่น", desc: "ส่วนประกอบของคลื่น คลื่นแม่เหล็กไฟฟ้า" },
                    { id: 2, title: "แสงและการมองเห็น", desc: "การสะท้อน การหักเห เลนส์ และทัศนอุปกรณ์" },
                    { id: 3, title: "ระบบสุริยะของเรา", desc: "ปฏิสัมพันธ์ในระบบสุริยะ และเทคโนโลยีอวกาศ" },
                    { id: 4, title: "พันธุศาสตร์", desc: "การถ่ายทอดลักษณะทางพันธุกรรม โครโมโซม DNA" },
                    { id: 5, title: "คลื่นและแสง", desc: "สมบัติของคลื่นและแสงในชีวิตประจำวัน" },
                    { id: 6, title: "ระบบนิเวศ", desc: "ความสัมพันธ์ของสิ่งมีชีวิตในระบบนิเวศ โซ่อาหาร สายใยอาหาร" },
                    { id: 7, title: "ความหลากหลายทางชีวภาพ", desc: "ความหลากหลายของพืชและสัตว์ การอนุรักษ์" },
                    { id: 8, title: "วัสดุในชีวิตประจำวัน", desc: "พอลิเมอร์ เซรามิก และวัสดุผสม" },
                    { id: 9, title: "ปฏิกิริยาเคมี", desc: "การเกิดปฏิกิริยาเคมี สมการเคมี และผลกระทบ" },
                    { id: 10, title: "ไฟฟ้า", desc: "วงจรไฟฟ้าเบื้องต้น กฎของโอห์ม พลังงานไฟฟ้า" },
                    { id: 11, title: "อิเล็กทรอนิกส์เบื้องต้น", desc: "ชิ้นส่วนอิเล็กทรอนิกส์ ไดโอด ทรานซิสเตอร์" }
                ]
            },
            eng: {
                title: "ภาษาอังกฤษ (English)",
                chapters: [
                    { id: 1, title: "Tenses Review", desc: "Present Perfect, Past Continuous, and Future forms" },
                    { id: 2, title: "Passive Voice", desc: "Understanding Active vs Passive voice in different tenses" },
                    { id: 3, title: "Conditional Sentences", desc: "If-clauses: Type 1, 2, and 3" },
                    { id: 4, title: "Direct & Indirect Speech", desc: "Reporting statements, questions, and commands" },
                    { id: 5, title: "Relative Clauses", desc: "Who, Which, That, Whose, Where" },
                    { id: 6, title: "Modal Verbs", desc: "Can, Could, Should, Must, Have to, Might" },
                    { id: 7, title: "Question Tags", desc: "Forming question tags correctly" },
                    { id: 8, title: "Gerunds & Infinitives", desc: "Verbs followed by -ing or to + verb" },
                    { id: 9, title: "Reading Comprehension", desc: "Skills for understanding main ideas and details" },
                    { id: 10, title: "Vocabulary: Environment", desc: "Words related to nature and global issues" },
                    { id: 11, title: "Writing Skills", desc: "Paragraph structure and essay writing basics" }
                ]
            }
        };

        // --- Auth Check ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is logged in
            const userStr = localStorage.getItem('otu_user');
            if (!userStr) {
                // Not logged in -> Redirect to index
                window.location.href = 'index.html';
                return;
            }

            // Load User Profile
            const user = JSON.parse(userStr);
            document.getElementById('user-name-display').innerText = user.name;
            document.getElementById('user-school-logo').src = user.logo || 'default_school.png';

            // Init UI
            setTimeout(() => {
                document.getElementById('preloader').style.opacity = '0';
                document.getElementById('preloader').style.visibility = 'hidden';
                document.getElementById('main-content').style.filter = 'blur(0px)';
                createParticles();
                loadYouTubeAPI();
            }, 1500);

            // Load Theme
            const savedTheme = localStorage.getItem('otu_theme') || 'dark';
            if (savedTheme === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        });

        // --- Subject Modal Logic ---
        const modal = document.getElementById('subject-modal');
        const modalBox = document.getElementById('subject-modal-box');
        
        function openSubjectModal(subjectKey) {
            const data = subjectsData[subjectKey];
            if(!data) return;

            // Set Title
            document.getElementById('modal-subject-title').innerText = data.title;
            
            // Populate List
            const listContainer = document.getElementById('chapter-list-container');
            listContainer.innerHTML = '';
            
            data.chapters.forEach(chap => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left px-5 py-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 hover:border-neonBlue/50 transition-all group flex items-center justify-between';
                btn.onclick = () => showChapterDetail(chap);
                
                btn.innerHTML = `
                    <div>
                        <span class="text-xs text-neonBlue font-bold uppercase tracking-wider block mb-1">บทที่ ${chap.id}</span>
                        <span class="text-sm font-medium text-gray-200 group-hover:text-white transition">${chap.title}</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-500 group-hover:text-neonBlue transition transform group-hover:translate-x-1"></i>
                `;
                listContainer.appendChild(btn);
            });

            // Reset Details View
            document.getElementById('detail-chapter-num').innerText = "เลือกบทเรียน";
            document.getElementById('detail-chapter-title').innerText = "ยินดีต้อนรับ";
            document.getElementById('detail-chapter-desc').innerText = "กรุณาเลือกบทเรียนจากเมนูทางด้านซ้ายเพื่อดูรายละเอียดและเริ่มทำแบบทดสอบ";
            document.getElementById('start-test-btn').classList.add('hidden');

            // Show Modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBox.classList.remove('scale-95', 'opacity-0');
                modalBox.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function showChapterDetail(chapter) {
            // Animate Text Change
            const content = document.getElementById('chapter-detail-content');
            content.classList.add('opacity-0', 'translate-y-2');
            
            setTimeout(() => {
                document.getElementById('detail-chapter-num').innerText = `บทที่ ${chapter.id}`;
                document.getElementById('detail-chapter-title').innerText = chapter.title;
                document.getElementById('detail-chapter-desc').innerText = chapter.desc;
                document.getElementById('start-test-btn').classList.remove('hidden');
                
                content.classList.remove('opacity-0', 'translate-y-2');
            }, 200);
        }

        function closeSubjectModal() {
            modalBox.classList.remove('scale-100', 'opacity-100');
            modalBox.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function startTest() {
            alert('กำลังเข้าสู่หน้าทำแบบทดสอบ... (จำลอง)');
            // window.location.href = 'Test.html'; 
        }

        // --- Common Logic (Logout, Theme, Music, Particles) ---
        // Same as Index.html logic
        function openLogoutModal() { document.getElementById('logout-modal').classList.remove('hidden'); }
        function closeLogoutModal() { document.getElementById('logout-modal').classList.add('hidden'); }
        function confirmLogout() {
            localStorage.removeItem('otu_user');
            window.location.href = 'index.html';
        }
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark'); localStorage.setItem('otu_theme', 'light');
            } else {
                html.classList.add('dark'); localStorage.setItem('otu_theme', 'dark');
            }
        }

        // Music
        let player, isPlaying = false;
        function loadYouTubeAPI() {
            if(!window.YT) {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '0', width: '0', videoId: '9SLgQEznnSk',
                playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': '9SLgQEznnSk', 'controls': 0 },
                events: {
                    'onReady': (e) => { e.target.setVolume(20); e.target.playVideo(); },
                    'onStateChange': (e) => {
                         const disc = document.querySelector('.disc-img');
                         if(e.data == 1) { 
                             isPlaying = true; 
                             disc.style.animationPlayState = 'running'; 
                             document.getElementById('play-icon').className = 'fas fa-pause text-white text-3xl drop-shadow-md';
                             const info = document.getElementById('music-info');
                             info.style.opacity = '1'; setTimeout(() => info.style.opacity = '0', 4000);
                         } else { 
                             isPlaying = false; 
                             disc.style.animationPlayState = 'paused';
                             document.getElementById('play-icon').className = 'fas fa-play text-white text-3xl drop-shadow-md';
                         }
                    }
                }
            });
        }
        function togglePlay() { if(player) isPlaying ? player.pauseVideo() : player.playVideo(); }

        // Particles
        function createParticles() {
            const container = document.getElementById('particles');
            for(let i=0; i<25; i++) {
                const dot = document.createElement('div');
                dot.className = 'absolute rounded-full bg-white/20';
                const size = Math.random() * 6 + 2;
                dot.style.width = `${size}px`; dot.style.height = `${size}px`;
                dot.style.left = `${Math.random() * 100}%`; dot.style.top = `${Math.random() * 100}%`;
                dot.animate([
                    { transform: 'translateY(0) rotate(0deg)', opacity: 0 },
                    { opacity: 0.6, offset: 0.5 },
                    { transform: `translateY(-${window.innerHeight}px) rotate(360deg)`, opacity: 0 }
                ], { duration: Math.random() * 10000 + 10000, iterations: Infinity, delay: Math.random() * 5000 });
                container.appendChild(dot);
            }
        }
        const ayanokoji = document.getElementById('ayanokoji-img');
        document.querySelector('main').addEventListener('mousemove', (e) => {
            const x = (window.innerWidth - e.pageX * 2) / 60;
            const y = (window.innerHeight - e.pageY * 2) / 60;
            ayanokoji.style.transform = `translate(${x}px, ${y}px)`;
        });
    </script>
</body>
</html>